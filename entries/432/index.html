<html>
<head>
    <title>BLOG.IK.AM</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css" rel="stylesheet"/>
    <style>
        body {
            font-size: small;
            font-family: "Sawarabi Mincho";
            margin: 20px;
        }

        a {
            color: darkslategray;
            text-decoration: none;
        }

        article {
            border: darkgrey solid 1px;
            border-radius: 10px;
            padding: 0 10px 10px;
        }

        footer {
            margin: 10px;
        }

        blockquote {
            color: #464646;
            font-style: italic;
            border: darkgrey dotted 1px;
            border-radius: 5px;
            margin: 5px 0;
            padding: 10px;
        }

        pre {
            background-color: dimgray;
            color: white;
            padding: 5px;
            border-radius: 5px;
        }

        h3:before {
            content: "â˜•ï¸ ";
        }

        h4:before {
            content: "ğŸƒ ";
        }

        h5:before {
            content: "âœˆï¸ï¸ ";
        }

        h6:before {
            content: "â˜ï¸ ";
        }

        pre {
            margin-bottom: 10px;
        }
    </style>
</head>
<h1>âœï¸ BLOG.IK.AM</h1>
<p><a href="https://twitter.com/making">@making</a>'s memo</p>
<body>
<article>
    <h2><a href="">Concourse CIã®Vaulté€£æºãƒ¡ãƒ¢</a></h2>
    <p>
        Updated at <span>2017-08-10T14:05:35Z</span> by <span>Toshiaki Maki</span><br>
        Created at <span>2017-08-06T18:33:51Z</span> by <span>Toshiaki Maki</span>
    </p>
    <div><p><strong>ç›®æ¬¡</strong></p>
<!-- toc -->
<ul>
<li><a href="#vault-">Vaultã®è¨­å®š</a><ul>
<li><a href="#approle-">AppRoleèªè¨¼ã®æœ‰åŠ¹åŒ–</a></li>
<li><a href="#concourse-">Concourseç”¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒã‚¦ãƒ³ãƒˆ</a></li>
<li><a href="#-">ãƒãƒªã‚·ãƒ¼é©ç”¨</a></li>
<li><a href="#approle-">AppRoleã®ä½œæˆ</a></li>
<li><a href="#role-id-">Role IDã®å–å¾—</a></li>
<li><a href="#secret-id-">Secret IDã®ç™ºè¡Œ</a></li>
<li><a href="#-">ãƒ­ã‚°ã‚¤ãƒ³</a></li>
</ul>
</li>
<li><a href="#concourse-manifest-">Concourseã®Manifestä¿®æ­£</a></li>
<li><a href="#-">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤</a></li>
<li><a href="#-url">å‚è€ƒURL</a></li>
</ul>
<!-- tocstop -->
<p>Concourse 3.3ã§è¿½åŠ ã•ã‚ŒãŸ<a href="http://concourse.ci/creds.html">Credential Management</a>(Vaultå¯¾å¿œ)ã‚’è©¦ã™ã€‚</p>
<p>ä»Šã¾ã§ã€å¹³æ–‡ã§ç®¡ç†ã•ã‚Œã¦ã„ãŸæ©Ÿå¯†æƒ…å ±ã¯ã‚ˆã†ã‚„ãVaultã‚µãƒ¼ãƒãƒ¼ã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚</p>
<p>ä»Šå›ã¯å¤–éƒ¨Vaultã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã€<a href="https://blog.ik.am/entries/423">Cloud Foundryã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸVault</a>ã‚’åˆ©ç”¨ã™ã‚‹ã€‚<a href="https://run.pivotal.io">Pivotal Web Services</a>ã§ã¯æœˆ100å††ä»¥ä¸‹(ç„¡æ–™æœŸé–“ã‚ã‚Š)ã§ç®¡ç†ã§ãã‚‹ã®ã§ãŠã™ã™ã‚ã€‚</p>
<p>ä»¥ä¸‹ã¯ã“ã®Vaultã«ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸçŠ¶æ…‹ã§å§‹ã‚ã‚‹ã€‚</p>
<blockquote>
<p>&quot;Concourse&quot;ã¨ã„ã†å‘¼ã³æ–¹ãŒæ­£ã—ã„ãŒã€ã‚¿ã‚¤ãƒˆãƒ«ã§ã¯ã‚°ã‚°ãƒ©ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚ã«&quot;Concourse CI&quot;ã¨æ›¸ã„ã¦ã„ã‚‹ã€‚</p>
</blockquote>
<h3 id="vault-">Vaultã®è¨­å®š</h3>
<p>Vaultã¨ã®é€£æºæ–¹å¼ã¯</p>
<ul>
<li><a href="https://www.vaultproject.io/docs/auth/approle.html">AppRole</a></li>
<li><a href="https://www.vaultproject.io/docs/auth/cert.html">TLS</a></li>
<li><a href="https://www.vaultproject.io/docs/auth/token.html">Token</a></li>
</ul>
<p>ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŒã€ä»Šå›ã¯AppRoleã‚’ä½¿ç”¨ã™ã‚‹ã€‚Tokenã®æ–¹ãŒè¨­å®šãŒæ¥½ã ã‘ã‚Œã©ã€AppRoleã®æ–¹ãŒæ¨å¥¨ã£ã½ã„ã€‚</p>
<p>AppRoleã‚‚Tokenã‚‚<a href="https://www.vaultproject.io/docs/concepts/tokens.html#periodic-tokens">Periodic Token</a>ã«ã—ãªã„ã¨ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã‚‹ãŸã³ã«è¨­å®šã—ç›´ã—ã«ãªã‚‹ã®ã§æ³¨æ„ã€‚</p>
<h4 id="approle-">AppRoleèªè¨¼ã®æœ‰åŠ¹åŒ–</h4>
<pre><code>vault auth-enable approle
</code></pre><h4 id="concourse-">Concourseç”¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒã‚¦ãƒ³ãƒˆ</h4>
<pre><code>vault mount -path=/concourse -description=&quot;Secrets for concourse pipelines&quot; generic
</code></pre><p><code>vault mounts</code>ã§ãƒã‚¦ãƒ³ãƒˆä¸€è¦§ã‚’ç¢ºèª</p>
<pre><code>$ vault mounts
Path        Type       Default TTL  Max TTL  Force No Cache  Replication Behavior  Description
concourse/  generic    system       system   false           replicated            Secrets for concourse pipelines
cubbyhole/  cubbyhole  n/a          n/a      false           local                 per-token private secret storage
secret/     generic    system       system   false           replicated            generic secret storage
sys/        system     n/a          n/a      false           replicated            system endpoints used for control, policy and debugging
totp/       totp       system       system   false           replicated            
transit/    transit    system       system   false           replicated
</code></pre><h4 id="-">ãƒãƒªã‚·ãƒ¼é©ç”¨</h4>
<p>writeã—ãŸå€¤ã‚’ConcourseãŒreadã§ãã‚‹ã‚ˆã†ã«æ¬¡ã®ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«(<code>policy.hcl</code>)ã‚’ä½œæˆ</p>
<pre><code>path &quot;concourse/*&quot; {
  policy = &quot;read&quot;
  capabilities =  [&quot;read&quot;, &quot;list&quot;]
}
</code></pre><p>ãã—ã¦è¨­å®š</p>
<pre><code>vault policy-write concourse policy.hcl
</code></pre><h4 id="approle-">AppRoleã®ä½œæˆ</h4>
<p><code>concourse</code>ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã™ã‚‹ã€‚</p>
<pre><code>vault write auth/approle/role/concourse secret_id_ttl=10m token_num_uses=10 token_ttl=20m token_max_ttl=30m period=768h secret_id_num_uses=20 policies=concourse
</code></pre><h4 id="role-id-">Role IDã®å–å¾—</h4>
<pre><code>vault read auth/approle/role/concourse/role-id
</code></pre><p>å¤‰æ•°ã«ä»£å…¥ã—ãŸã„å ´åˆã¯ã€</p>
<pre><code>export ROLE_ID=`vault read auth/approle/role/concourse/role-id | grep role_id | awk &#39;{print $2}&#39;`
</code></pre><p>ã§ã€‚</p>
<h4 id="secret-id-">Secret IDã®ç™ºè¡Œ</h4>
<pre><code>vault write -f auth/approle/role/concourse/secret-id
</code></pre><p>å¤‰æ•°ã«ä»£å…¥ã—ãŸã„å ´åˆã¯ã€</p>
<pre><code>export SECRET_ID=`vault write -f auth/approle/role/concourse/secret-id | grep secret_id | head -1 | awk &#39;{print $2}&#39;`
</code></pre><p>ã§ã€‚</p>
<p>æœ¬è¨˜äº‹ã§ã¯æ¬¡ã®å€¤ã‚’ä½¿ç”¨ã™ã‚‹ã€‚</p>
<pre><code>$ echo ${ROLE_ID}
96bfd1e4-8d9b-447f-81b3-8158233bae07
$ echo ${SECRET_ID}
1c9b7f4c-f7dc-445d-9a4b-ce13874fd339
</code></pre><h4 id="-">ãƒ­ã‚°ã‚¤ãƒ³</h4>
<pre><code>vault write auth/approle/login role_id=${ROLE_ID} secret_id=${SECRET_ID}
</code></pre><h3 id="concourse-manifest-">Concourseã®Manifestä¿®æ­£</h3>
<pre><code class="lang-yaml">  instance_groups:
  - name: web
    jobs:
    - name: atc
      properties:
        # (çœç•¥)

        # ã“ã“ã‹ã‚‰è¿½åŠ 
        vault:
          auth:
            backend: approle
            params:
              role_id: ((vault_role_id))
              secret_id: ((vault_secret_id))
          url: ((vault_url))
</code></pre>
<p>ã‚’è¨­å®šã™ã‚Œã°è‰¯ã„ã€‚ç›´æ¥manifestãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã—ã¦ã‚‚ã„ã„ãŒã€BOSH CLI v2ã®<a href="http://bosh.io/docs/cli-ops-files.html">Operation Files</a>ã‚’ä½¿ã†ã¨å·®åˆ†ã ã‘ç®¡ç†ã§ãã‚‹ã€‚ä»Šå›ã¯ã“ã¡ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã€‚æ¬¡ã®ã‚ˆã†ãª<code>concourse-vault.yml</code>ã‚’ä½œæˆã™ã‚‹ã€‚</p>
<pre><code class="lang-yaml">- type: replace
  path: /instance_groups/name=web/jobs/name=atc/properties/vault?
  value:
    url: ((vault_url))
    auth:
      backend: approle
      params:
        role_id: ((vault_role_id))
        secret_id: ((vault_secret_id))
</code></pre>
<p><code>bosh deploy</code>æ™‚ã«<code>-o</code>ã§Operation Fileã‚’æŒ‡å®šã™ã‚‹ã€‚</p>
<pre><code>bosh deploy -d concourse \
  concourse.yml \
  -o ops-files/concourse-vault.yml \
  -v internal_ip=10.244.0.200 \
  -v external_ip=concourse.example.com \
  -v vault_url=https://vault.example.com \
  -v vault_role_id=96bfd1e4-8d9b-447f-81b3-8158233bae07 \
  -v vault_secret_id=1c9b7f4c-f7dc-445d-9a4b-ce13874fd339
</code></pre><p>ã“ã‚Œã§ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã€‚</p>
<blockquote>
<p>vaultã§è‡ªå·±è¨¼æ˜æ›¸ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯<code>vault.tls.ca_cert</code>ã‚‚å¿…è¦ã€‚</p>
</blockquote>
<p>CredHubã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯</p>
<pre><code>credhub set -n &quot;/Bosh Lite Director/concourse/vault_role_id&quot; --type=value -v 96bfd1e4-8d9b-447f-81b3-8158233bae07
credhub set -n &quot;/Bosh Lite Director/concourse/vault_secret_id&quot; --type=value -v 1c9b7f4c-f7dc-445d-9a4b-ce13874fd339
</code></pre><p>ã‚’è¨­å®šã—ã€</p>
<pre><code>bosh deploy -d concourse \
  concourse.yml \
  -o ops-files/concourse-vault.yml \
  -v internal_ip=10.244.0.200 \
  -v external_ip=concourse.example.com \
  -v vault_url=https://vault.example.com
</code></pre><p>ã§OKã€‚</p>
<h3 id="-">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤</h3>
<p>ç°¡å˜ãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³(<code>hello.yml</code>)ã‚’ä½œæˆã€‚</p>
<p>ã“ã‚Œã¾ã§å¤–éƒ¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯<code>{{param}}</code>ã§è¨­å®šã—ã¦ã„ãŸãŒã“ã‚Œã¯ç©´åŸ‹ã‚ã—ãŸã ã‘ã§ã€å€¤ãŒä¸¸è¦‹ãˆã ã£ãŸã€‚
Vaulté€£æºã®å ´åˆã¯<code>((param))</code>ã§è¨­å®šã™ã‚‹ã€‚ã“ã®å ´åˆã€<code>param</code>ã¯ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œæ™‚ã«Vaultã®<code>concourse/&lt;team-name&gt;/&lt;pipeline-name&gt;/&lt;param&gt;</code>ã‹ã‚‰å–å¾—ã™ã‚‹ã€‚</p>
<pre><code class="lang-yaml">jobs:
- name: hello-world
  plan:
  - task: say-hello
    params:
      MY_SECRET: ((my-secret))
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: ubuntu
      run:
        path: bash
        args:
        - -c
        - |
          echo &quot;MY_SECRET is ${MY_SECRET}&quot;
</code></pre>
<p>ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚</p>
<pre><code>fly -t dev sp -p hello -c hello.yml 
fly -t dev up -p hello
</code></pre><p>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’Vaultã«è¨­å®šã™ã‚‹ã€‚</p>
<pre><code>vault write concourse/&lt;team-name&gt;/hello/my-secret value=FOO
</code></pre><blockquote>
<p>å®Ÿéš›ã¯ã€Teamã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¦ã€<code>concourse/&lt;team-name&gt;/*</code>ä»¥ä¸‹ã®ã¿read-writeã§ãã‚‹æ¨©é™ã‚’æŒã¤ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã™ã¹ãã€‚</p>
</blockquote>
<p>ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã€‚</p>
<pre><code>$ fly -t dev tj -j hello/hello-world --watch

started hello/hello-world #12

initializing
running bash -c echo &quot;MY_SECRET is ${MY_SECRET}&quot;

MY_SECRET is FOO
succeeded
</code></pre><p>Vaultã‹ã‚‰å€¤ãŒå–ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚</p>
<blockquote>
<p>403ã‚¨ãƒ©ãƒ¼(permission denied)ãŒå‡ºã‚‹å ´åˆã¯ã€ãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‹ã€ATCã«è¨­å®šã—ãŸSECRET IDã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚Vaultã®ãƒ­ã‚°ã‚’è¦ãƒã‚§ãƒƒã‚¯ã€‚</p>
</blockquote>
<h3 id="-url">å‚è€ƒURL</h3>
<ul>
<li><a href="https://github.com/pivotalservices/concourse-pipeline-samples/tree/master/concourse-pipeline-patterns/vault-integration">https://github.com/pivotalservices/concourse-pipeline-samples/tree/master/concourse-pipeline-patterns/vault-integration</a></li>
<li><a href="https://github.com/rahul-kj/concourse-vault">https://github.com/rahul-kj/concourse-vault</a></li>
<li><a href="https://www.vaultproject.io/docs/auth/approle.html">https://www.vaultproject.io/docs/auth/approle.html</a></li>
<li><a href="http://concourse.ci/creds.html">http://concourse.ci/creds.html</a></li>
</ul>
<hr>
<p>æ¬¡ã¯Vaultã‚‚Concourseã¨åŒæ™‚ã«BOSHã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’è©¦ã™ã€‚</p>
</div>
</article>
<footer>
    <a href="https://blog.ik.am">BLOG.IK.AM</a> â€” &copy; 2010-2017 <a href="https://twitter.com/making">Toshiaki
    Maki</a>
</footer>
</body>
</html>