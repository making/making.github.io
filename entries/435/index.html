<html>
<head>
    <title>BLOG.IK.AM</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css" rel="stylesheet"/>
    <style>
        body {
            font-size: small;
            font-family: "Sawarabi Mincho";
            margin: 20px;
        }

        a {
            color: darkslategray;
            text-decoration: none;
        }

        article {
            border: darkgrey solid 1px;
            border-radius: 10px;
            padding: 0 10px 10px;
        }

        footer {
            margin: 10px;
        }

        blockquote {
            color: #464646;
            font-style: italic;
            border: darkgrey dotted 1px;
            border-radius: 5px;
            margin: 5px 0;
            padding: 10px;
        }

        pre {
            background-color: dimgray;
            color: white;
            padding: 5px;
            border-radius: 5px;
        }

        h3:before {
            content: "â˜•ï¸ ";
        }

        h4:before {
            content: "ğŸƒ ";
        }

        h5:before {
            content: "âœˆï¸ï¸ ";
        }

        h6:before {
            content: "â˜ï¸ ";
        }

        pre {
            margin-bottom: 10px;
        }
    </style>
</head>
<h1>âœï¸ BLOG.IK.AM</h1>
<p><a href="https://twitter.com/making">@making</a>'s memo</p>
<body>
<article>
    <h2><a href="">Kubo(Kubernetes on BOSH)ã‚’GCPã«ãƒ‡ãƒ—ãƒ­ã‚¤</a></h2>
    <p>
        Updated at <span>2017-09-30T19:59:52Z</span> by <span>Toshiaki Maki</span><br>
        Created at <span>2017-08-21T14:46:53Z</span> by <span>Toshiaki Maki</span>
    </p>
    <div><p><strong>ç›®æ¬¡</strong></p>
<!-- toc -->
<ul>
<li><a href="#kubo-">Kuboã¨ã¯</a></li>
<li><a href="#gcp-">GCPç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</a></li>
<li><a href="#bosh-">BOSHã®ãƒ‡ãƒ—ãƒ­ã‚¤</a></li>
<li><a href="#routing-">Routingæ–¹å¼ã®è¨­å®š</a></li>
<li><a href="#kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®ãƒ‡ãƒ—ãƒ­ã‚¤</a></li>
<li><a href="#kubernetes-">Kubernetesã¸ã®ã‚¢ã‚¯ã‚»ã‚¹</a></li>
<li><a href="#-">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤</a></li>
<li><a href="#bosh-resurrection">BOSHã«ã‚ˆã‚‹Resurrection</a></li>
<li><a href="#kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³</a></li>
<li><a href="#kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®åœæ­¢</a></li>
<li><a href="#kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®å†é–‹</a></li>
<li><a href="#kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®å‰Šé™¤</a></li>
</ul>
<!-- tocstop -->
<h3 id="kubo-">Kuboã¨ã¯</h3>
<p>Kuboã¯Kubernetesã®<a href="https://bosh.io">BOSH</a> Releaseã§ã™ã€‚BOSHã‚’åˆ©ç”¨ã—ã¦ã€Kubernetesã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€é‹ç”¨ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<ul>
<li><a href="https://pivotal.io/jp/partners/kubo">https://pivotal.io/jp/partners/kubo</a></li>
<li><a href="https://github.com/cloudfoundry-incubator/kubo-deployment">https://github.com/cloudfoundry-incubator/kubo-deployment</a></li>
</ul>
<p>Pivotalã¨Googleã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§å…±åŒé–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/ed1bb4ed-dfdd-ed0c-60f5-700b0fd23e61.png" alt="image.png"></p>
<p>BOSHã¯Cloud Foundryã®é‹ç”¨ã«ãŠã„ã¦é•·ãä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
<p>BOSHã‚‚Kubernetesã‚‚Googleã®Borgã‚’èµ·æºã¨ã—ã¦ãŠã‚Šã€KubernetesãŒã‚³ãƒ³ãƒ†ãƒŠã®ç®¡ç†ã‚’ã™ã‚‹ã®ã«å¯¾ã—ã¦ã€BOSHã¯åŒã˜ã‚ˆã†ã«ã€ãã®ä¸‹ã®VMã®ç®¡ç†ã‚’è¡Œã„ã¾ã™ã€‚</p>
<p>BOSHã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€</p>
<ul>
<li>ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒ(GCP, AWS, Azure, vSphere, OpenStack)ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ (ã‚¯ãƒ©ã‚¹ã‚¿ã‚’åˆ†æ•£ã§ãã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“)</li>
<li>Day 1 Operation(k8sã‚¯ãƒ©ã‚¹ã‚¿ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ãƒ‡ãƒ—ãƒ­ã‚¤)ã ã‘ã§ãªãã€Day 2 Operation(k8sã‚¯ãƒ©ã‚¹ã‚¿è‡ªä½“ã®è‡ªå‹•å¾©æ—§ã€ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã€Multi-AZå¯¾å¿œã€ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ)ã«å¯¾å¿œã§ãã‚‹</li>
</ul>
<p>ãªã©ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã€ä»–ã®Kubernetesãƒ‡ãƒ—ãƒ­ã‚¤ãƒ„ãƒ¼ãƒ«ã¨ã®é•ã„ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<p>GKEã‚„ACSã®ã‚ˆã†ãªManaged KubernetesãŒä½¿ãˆãªã„å ´åˆã‚„ã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¯ãƒ©ã‚¦ãƒ‰ã¨ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã§åŒã˜ç’°å¢ƒã‚’ä½¿ã„ãŸã„å ´åˆã®é­…åŠ›çš„ãªé¸æŠè‚¢ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚</p>
<p>æœ¬è¨˜äº‹ã®åŸ·ç­†æ™‚ç‚¹ã§ã¯Kubo(v0.6.0)ã¯</p>
<ul>
<li>GCP</li>
<li>vSphere</li>
<li>OpenStack</li>
<li>AWS</li>
</ul>
<p>ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</p>
<p>ä»¥ä¸‹ã¯GCPã«Kuboã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸæ™‚ã®ãƒ¡ãƒ¢ã§ã™ã€‚</p>
<p>ä½¿ç”¨ã—ãŸcommitã¯</p>
<ul>
<li><a href="https://github.com/cloudfoundry-incubator/kubo-deployment/tree/34e334346a7801c874dede7441466a3ed70d794b">kubo-deployment#34e334346a7801c874dede7441466a3ed70d794b</a></li>
<li><a href="https://github.com/cloudfoundry-incubator/kubo-release/tree/25bad93ecb13fdb9c42f8be23b67571501331c20">kubo-release#25bad93ecb13fdb9c42f8be23b67571501331c20</a></li>
</ul>
<p>ã§ã™ã€‚</p>
<h3 id="gcp-">GCPç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3>
<p>ã¾ãšã¯GCPã«BOSHã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®ä¸‹æº–å‚™ã§ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/a4d1edb0-3c1f-e5dd-00d5-119aff159177.png" alt="image.png"></p>
<p>Google Cloud Shellã§ä½œæ¥­ã—ã¾ã™ã€‚</p>
<p>ã¾ãšã¯IAMã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<pre><code>export project_id=$(gcloud config get-value project)
export region=asia-northeast1
export zone=asia-northeast1-a
export prefix=${project_id}-kubo
export service_account_email=${prefix}terraform@${project_id}.iam.gserviceaccount.com
export network=${prefix}-net
export subnet_ip_prefix=&quot;10.0.1&quot;

gcloud config set compute/zone ${zone}
gcloud config set compute/region ${region}
gcloud compute --project=${project_id} networks create ${network} --mode=custom

gcloud iam service-accounts create ${prefix}terraform
gcloud iam service-accounts keys create ~/terraform.key.json --iam-account ${service_account_email}
gcloud projects add-iam-policy-binding ${project_id} --member serviceAccount:${service_account_email} --role roles/owner
export GOOGLE_CREDENTIALS=$(cat ~/terraform.key.json)
</code></pre><p>æ¬¡ã«Bastion(è¸ã¿å°)ã‚µãƒ¼ãƒãƒ¼ã¨NATã®VMã‚’Terraformã§ä½œæˆã—ã¾ã™ã€‚</p>
<pre><code>cd ~
git clone https://github.com/cloudfoundry-incubator/kubo-deployment.git
cd ~/kubo-deployment/docs/user-guide/platforms/gcp
docker run -i -t \
  -v $(pwd):/$(basename $(pwd)) \
  -w /$(basename $(pwd)) \
  hashicorp/terraform:light init
docker run -i -t \
  -e CHECKPOINT_DISABLE=1 \
  -e &quot;GOOGLE_CREDENTIALS=${GOOGLE_CREDENTIALS}&quot; \
  -v $(pwd):/$(basename $(pwd)) \
  -w /$(basename $(pwd)) \
  hashicorp/terraform:light apply \
    -var service_account_email=${service_account_email} \
    -var projectid=${project_id} \
    -var network=${network} \
    -var region=${region} \
    -var prefix=${prefix} \
    -var zone=${zone} \
    -var subnet_ip_prefix=${subnet_ip_prefix}
gcloud compute scp ~/terraform.key.json &quot;${prefix}bosh-bastion&quot;:./ --zone ${zone}
gcloud compute scp --recurse ~/kubo-deployment &quot;${prefix}bosh-bastion&quot;:/share/ --zone ${zone}
</code></pre><p>ã‚µãƒ–ãƒãƒƒãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/30035cfa-b97e-8d02-d379-ebc6fd0fbd8b.png" alt="image.png"></p>
<p>VMãŒ2ã¤ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚<code>***bosh-bastion</code>ãŒBastion(è¸ã¿å°)ã‚µãƒ¼ãƒãƒ¼ã€<code>***nat-instance-primary</code>ãŒNATã§ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/6cae1d2d-ab25-9597-276b-e0f0973a90cd.png" alt="image.png"></p>
<p>ä»¥é™ã¯Bastionã‚µãƒ¼ãƒãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ä½œæ¥­ã—ã¾ã™ã€‚</p>
<pre><code>gcloud compute ssh &quot;${prefix}bosh-bastion&quot; --zone ${zone}
</code></pre><h3 id="bosh-">BOSHã®ãƒ‡ãƒ—ãƒ­ã‚¤</h3>
<p>æ¬¡ã«BOSH Directorã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<pre><code>cd /share/kubo-deployment

export kubo_envs=~/kubo-env
export kubo_env_name=kubo
export kubo_env_path=&quot;${kubo_envs}/${kubo_env_name}&quot;

mkdir -p &quot;${kubo_envs}&quot;
./bin/generate_env_config &quot;${kubo_envs}&quot; ${kubo_env_name} gcp
/usr/bin/update_gcp_env &quot;${kubo_env_path}/director.yml&quot;
./bin/deploy_bosh &quot;${kubo_env_path}&quot; ~/terraform.key.json
</code></pre><p>Labelã«<code>deployment=bosh, director=bosh-init</code>ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹VMãŒBOSH Directorã§ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/6325522f-7e09-fcb5-808e-7891af694e9c.png" alt="image.png"></p>
<h3 id="routing-">Routingæ–¹å¼ã®è¨­å®š</h3>
<p>Kuboã§ã¯Kubernetesã«å¯¾ã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ–¹å¼ã¨ã—ã¦</p>
<ul>
<li>CF (Cloud Foundryã¨é€£æºã—ã€GoRouter, TCPRouterã‹ã‚‰k8sã¸ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹)</li>
<li>IaaS (IaaSã®LBã‚’ä½¿ç”¨ã™ã‚‹)</li>
<li>HA Proxy (HA Proxyã‚’ä½¿ç”¨ã™ã‚‹)</li>
</ul>
<p>ãŒé¸æŠå¯èƒ½ã§ã™ã€‚ä»Šå›ã¯Kuboå˜ç‹¬ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãªã®ã§ã€IaaSã‚’é¸æŠã—ã¾ã™ã€‚</p>
<pre><code>cd /share/kubo-deployment/docs/user-guide/routing/gcp
export state_dir=~/kubo-env/${kubo_env_name}
export kubo_terraform_state=${state_dir}/terraform.tfstate
terraform apply \
    -var network=${network} \
    -var projectid=${project_id} \
    -var region=${region} \
    -var prefix=${prefix} \
    -var ip_cidr_range=&quot;${subnet_ip_prefix}.0/24&quot; \
    -state=${kubo_terraform_state}
export master_target_pool=$(terraform output -state=${kubo_terraform_state} kubo_master_target_pool)                                                                           
export kubernetes_master_host=$(terraform output -state=${kubo_terraform_state} master_lb_ip_address)
/usr/bin/set_iaas_routing &quot;${state_dir}/director.yml&quot;
</code></pre><p>ã¾ãšã¯Master Nodeã®API Serverã¸ã®LBãŒä½œæˆã•ã‚Œã¾ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/19a53b6f-083d-620b-81dd-b9253de6e262.png" alt="image.png"></p>
<h3 id="kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®ãƒ‡ãƒ—ãƒ­ã‚¤</h3>
<p>ã„ã‚ˆã„ã‚ˆã€BOSHã‚’ä½¿ã£ãŸKubernetesã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã™ã€‚</p>
<pre><code>cd /share/kubo-deployment
bin/deploy_k8s ${kubo_env_path} ${prefix}cluster
</code></pre><p>ã—ã°ã‚‰ãå¾…ã¤ã¨ã€VMãŒ8ã¤è¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>
<ul>
<li>master x 2</li>
<li>etcd x 3</li>
<li>worker x 3</li>
</ul>
<p>ã§ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/cb1ad78d-edbc-793e-1ec8-f0c267982447.png" alt="image.png"></p>
<p>BOSH Directorã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦BOSH CLIã‚’ä½¿ç”¨ã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>export BOSH_ENVIRONMENT=`gcloud compute instances list --filter labels.deployment=bosh | grep RUNNING | awk &#39;{print $4}&#39;`
export BOSH_CLIENT=admin
export BOSH_CLIENT_SECRET=`bosh-cli int ${kubo_env_path}/creds.yml --path /admin_password`
export BOSH_CA_CERT=`bosh-cli int ${kubo_env_path}/creds.yml --path /director_ssl/ca`
</code></pre><p><code>bosh-cli vms</code>ã§BOSHã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸVMä¸€è¦§ã‚’å–å¾—ã§ãã¾ã™ã€‚</p>
<pre><code>$ bosh-cli vms
Using environment &#39;10.0.1.252&#39; as client &#39;admin&#39;
Task 6. Done
Deployment &#39;fe-tmaki-kubocluster&#39;
Instance                                     Process State  AZ  IPs        VM CID                                   VM Type
etcd/29fc3df2-45dd-4f9c-9314-327a13a32283    running        z1  10.0.1.7   vm-b86faa89-8726-4e86-7ef0-22cc86d479c9  common
etcd/7ea9a870-cc1e-490e-9ead-230a7ebc945a    running        z1  10.0.1.11  vm-0922c0b2-f997-4e0b-7c4e-26e2581eec23  common
etcd/aa84e25e-bfc4-4235-a668-520980338531    running        z1  10.0.1.10  vm-00b71b57-ccdb-453a-6249-a7bc9ef5832c  common
master/b003dbd2-b6a4-4d79-93b4-fb00d71cd4a1  running        z1  10.0.1.4   vm-2ade7004-28a7-48e3-42ce-d2750ce9c5c5  master
master/f63be039-ffd9-4783-bc78-dd26065d97fb  running        z1  10.0.1.9   vm-9e961a54-194c-4b82-7819-18df78d053ca  master
worker/ca43686b-058a-4c3e-8c71-7edc9aa2e756  running        z1  10.0.1.6   vm-7bc295ca-d71b-4f4c-4fb1-863f8d36f989  worker
worker/e0393799-dfe4-4a6a-be5c-fa21d6c71836  running        z1  10.0.1.5   vm-5c0eb0e7-1116-4a9a-7df3-67b213ecc2fa  worker
worker/e43c01fa-f49b-473c-85d4-11644a050fa7  running        z1  10.0.1.8   vm-08384a35-dbb6-421f-619c-3526b156100a  worker
8 vms
Succeeded
</code></pre><p><code>bosh-cli releases</code>ã§ä½¿ç”¨ä¸­ã®BOSH Release(ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ»ãƒã‚¤ãƒŠãƒªã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€èµ·å‹•ãƒ»ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¾¤)ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã™ã€‚</p>
<pre><code>$ bosh-cli releases
Using environment &#39;10.0.1.252&#39; as client &#39;admin&#39;
Name       Version       Commit Hash
docker     28.0.1*       8096ad43+
kubo       0.7.0-dev.3*  25bad93
kubo-etcd  2*            aa57fc9
</code></pre><p>GCPã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã‚’ç¢ºèªã™ã‚‹ã¨Master Nodeã«æŒ¯ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/d09d40a4-05e6-fec1-aa0e-12730a968ec6.png" alt="image.png"></p>
<h3 id="kubernetes-">Kubernetesã¸ã®ã‚¢ã‚¯ã‚»ã‚¹</h3>
<p>ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸKubernetesã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code>bin/set_kubeconfig ${kubo_env_path} ${prefix}cluster
</code></pre><p><code>~/.kube/config</code>ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã§<code>kubectl</code>ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚</p>
<pre><code>$ kubectl version
Client Version: version.Info{Major:&quot;1&quot;, Minor:&quot;7&quot;, GitVersion:&quot;v1.7.4&quot;, GitCommit:&quot;793658f2d7ca7f064d2bdf606519f9fe1229c381&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2017-08-17T08:48:23Z&quot;, GoVersion:&quot;go1.8.3&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;}
Server Version: version.Info{Major:&quot;1&quot;, Minor:&quot;7&quot;, GitVersion:&quot;v1.7.1&quot;, GitCommit:&quot;1dc5c66f5dd61da08412a74221ecc79208c2165b&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2017-07-14T01:48:01Z&quot;, GoVersion:&quot;go1.8.3&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;}

$ kubectl get pods --namespace=kube-system
NAME                                    READY     STATUS    RESTARTS   AGE
heapster-2986240809-t2x5m               1/1       Running   0          1h
kube-dns-3329716278-3wn5n               3/3       Running   0          1h
kubernetes-dashboard-1367211859-0zbv0   1/1       Running   0          1h
monitoring-influxdb-564852376-vn1f5     1/1       Running   0          1h

$ kubectl get node -o wide
NAME                                      STATUS    AGE       VERSION   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION
vm-08384a35-dbb6-421f-619c-3526b156100a   Ready     1h        v1.7.1                  Ubuntu 14.04.5 LTS   4.4.0-83-generic
vm-5c0eb0e7-1116-4a9a-7df3-67b213ecc2fa   Ready     1h        v1.7.1                  Ubuntu 14.04.5 LTS   4.4.0-83-generic
vm-7bc295ca-d71b-4f4c-4fb1-863f8d36f989   Ready     1h        v1.7.1                  Ubuntu 14.04.5 LTS   4.4.0-83-generic
</code></pre><h3 id="-">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤</h3>
<p>ç°¡å˜ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚æ¬¡ã®<code>hello-tomcat.yml</code></p>
<pre><code class="lang-yaml">kind: Service
apiVersion: v1
metadata:
  name: hello-tomcat-service
spec:
  selector:
    run: hello-tomcat
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  type: LoadBalancer
---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: hello-tomcat-deployment
spec:
  replicas: 2
  template:
    metadata:
      labels:
        run: hello-tomcat
    spec:
      containers:
      - name: hello-tomcat
        image: making/hello-tomcat:v1
        ports:
        - containerPort: 8080
</code></pre>
<p><code>kubectl create</code>ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚</p>
<pre><code>kubectl create -f hello-tomcat.yml
</code></pre><p>ã—ã°ã‚‰ãã™ã‚‹ã¨Podã¨ServiceãŒä½œæˆã•ã‚Œã€LBã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚</p>
<pre><code>$ kubectl get pods
NAME                                       READY     STATUS    RESTARTS   AGE
hello-tomcat-deployment-1598259564-0v4cp   1/1       Running   0          2m
hello-tomcat-deployment-1598259564-b2cqg   1/1       Running   0          2m

$  kubectl get service hello-tomcat-service -o wide
NAME                   CLUSTER-IP       EXTERNAL-IP    PORT(S)          AGE       SELECTOR
hello-tomcat-service   10.100.200.178   35.200.95.68   8080:32517/TCP   11m       run=hello-tomcat
</code></pre><p>GCPã®LBç”»é¢ã‚’è¦‹ã¦ã‚‚ã€ç¢ºã‹ã«æ–°è¦ã®LBãŒä½œæˆã•ã‚Œã€Worker Nodeã«æŒ¯ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/8bea9d4e-4c7a-5c95-36bc-ae7e2c17b2b5.png" alt="image.png"></p>
<p>ã“ã‚Œã§ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>
<pre><code>curl 35.200.95.68:8080
</code></pre><p>ã¨ã€æ€ã£ãŸã®ã§ã™ãŒã€ç¹‹ãŒã‚‰ãªã„......</p>
<p>ã‚ˆãã‚ˆãè¦‹ã¦ã¿ã‚‹ã¨ã€LBã«å¯¾å¿œã™ã‚‹Firewall RuleãŒé©ç”¨ã•ã‚Œã‚‹ã«ã¯<code>${prefix}bosh-kubo-worker</code>ã‚¿ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã™ãŒã€</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/e13364fb-19d5-947c-3879-0c247b918987.png" alt="image.png"></p>
<p>Worker Nodeã«ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€‚ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/6adcd78a-0f12-865a-6253-8682ff772d02.png" alt="image.png"></p>
<p>æ¬¡ã®issueãŒä¸ŠãŒã£ã¦ã„ã¾ã—ãŸã®ã§ãƒã‚°ã®ã‚ˆã†ã§ã™ã€‚</p>
<p><a href="https://github.com/cloudfoundry-incubator/kubo-deployment/issues/162">https://github.com/cloudfoundry-incubator/kubo-deployment/issues/162</a></p>
<p>ã“ã“ã¯ä¸€æ—¦Workarroundã¨ã—ã¦ã€æ‰‹å‹•ã§Worker Nodeã«tagã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<pre><code>for vm in `gcloud compute instances list --filter labels.job=worker | grep RUNNING | awk &#39;{print $1}&#39;`;do
  gcloud compute instances add-tags $vm --tags ${prefix}bosh-kubo-worker;
done
</code></pre><p>ã“ã‚Œã§ãªã‚“ã¨ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸã€‚</p>
<pre><code>$ curl 35.200.95.68:8080
&lt;html&gt;
&lt;body&gt;
&lt;h2&gt;Hello World!&lt;/h2&gt;
&lt;/body&gt;
&lt;/html&gt;

$ curl 35.200.95.68:8080/env
HELLO_TOMCAT_SERVICE_SERVICE_HOST: 10.100.200.178
PATH: /usr/local/tomcat/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
KUBERNETES_PORT: tcp://10.100.200.1:443
JAVA_HOME: /docker-java-home/jre
CA_CERTIFICATES_JAVA_VERSION: 20161107~bpo8+1
KUBERNETES_SERVICE_HOST: 10.100.200.1
LANG: C.UTF-8
TOMCAT_MAJOR: 8
TOMCAT_VERSION: 8.5.15
LD_LIBRARY_PATH: /usr/local/tomcat/native-jni-lib
OPENSSL_VERSION: 1.1.0e-2
HELLO_TOMCAT_SERVICE_PORT_8080_TCP_PROTO: tcp
TOMCAT_NATIVE_LIBDIR: /usr/local/tomcat/native-jni-lib
PWD: /usr/local/tomcat
JAVA_VERSION: 8u131
KUBERNETES_PORT_443_TCP: tcp://10.100.200.1:443
TOMCAT_TGZ_URL: https://www.apache.org/dyn/closer.cgi?action=download&amp;filename=tomcat/tomcat-8/v8.5.15/bin/apache-tomcat-8.5.15.tar.gz
KUBERNETES_PORT_443_TCP_ADDR: 10.100.200.1
HELLO_TOMCAT_SERVICE_PORT_8080_TCP_ADDR: 10.100.200.178
CATALINA_HOME: /usr/local/tomcat
HELLO_TOMCAT_SERVICE_PORT: tcp://10.100.200.178:8080
KUBERNETES_PORT_443_TCP_PROTO: tcp
HELLO_TOMCAT_SERVICE_SERVICE_PORT: 8080
HELLO_TOMCAT_SERVICE_PORT_8080_TCP_PORT: 8080
KUBERNETES_SERVICE_PORT: 443
HOSTNAME: hello-tomcat-deployment-1598259564-dhmnw
JAVA_DEBIAN_VERSION: 8u131-b11-1~bpo8+1
TOMCAT_ASC_URL: https://www.apache.org/dist/tomcat/tomcat-8/v8.5.15/bin/apache-tomcat-8.5.15.tar.gz.asc
KUBERNETES_PORT_443_TCP_PORT: 443
KUBERNETES_SERVICE_PORT_HTTPS: 443
HELLO_TOMCAT_SERVICE_PORT_8080_TCP: tcp://10.100.200.178:8080
GPG_KEYS: 05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 713DA88BE50911535FE716F5208B0AB1D63011C7 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 9BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23
HOME: /root
</code></pre><p>ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚¹ã§ãã¦ã„ã‚‹ã“ã¨ã‚‚ç¢ºèªã§ãã¾ã™ã€‚</p>
<pre><code>$ for i in `seq 1 10`;do curl -s 35.200.95.68:8080/env | grep HOSTNAME;done
HOSTNAME: hello-tomcat-deployment-1598259564-dhmnw
HOSTNAME: hello-tomcat-deployment-1598259564-dhmnw
HOSTNAME: hello-tomcat-deployment-1598259564-vbknx
HOSTNAME: hello-tomcat-deployment-1598259564-vbknx
HOSTNAME: hello-tomcat-deployment-1598259564-vbknx
HOSTNAME: hello-tomcat-deployment-1598259564-dhmnw
HOSTNAME: hello-tomcat-deployment-1598259564-vbknx
HOSTNAME: hello-tomcat-deployment-1598259564-vbknx
HOSTNAME: hello-tomcat-deployment-1598259564-dhmnw
HOSTNAME: hello-tomcat-deployment-1598259564-vbknx
</code></pre><h3 id="bosh-resurrection">BOSHã«ã‚ˆã‚‹Resurrection</h3>
<p>æ¬¡ã«BOSHã«ã‚ˆã‚‹VMã®Resurrection(è‡ªå‹•å¾©æ—§)ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚</p>
<p>ã‚ã–ã¨Worker Nodeã®ä¸€ã¤(<code>vm-e43c01fa-f49b-473c-85d4-11644a050fa7</code>)ã‚’GCPã®Consoleã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/274e599b-ceab-4964-845c-035d66e63d25.png" alt="image.png"></p>
<p>ã—ã°ã‚‰ãã™ã‚‹ã¨VMã®æ–°è¦ä½œæˆãŒå§‹ã¾ã‚Šã¾ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/b6c62361-5e06-076e-589b-f328de053b9b.png" alt="image.png"></p>
<p>ãã—ã¦ã€Worker Nodeã¨ã—ã¦å¾©å¸°ã—ã¾ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/81ed5558-ee97-d996-7acf-386ca7fb2c08.png" alt="image.png"></p>
<p>ã“ã®æ©Ÿèƒ½ã¯BOSHã®æ¨™æº–æ©Ÿèƒ½ã§ã‚ã‚Šã€ç‰¹åˆ¥ãªè¨­å®šã¯ä¸è¦ã§ã™ã€‚</p>
<p>(ãŒã€ã¾ãŸã—ã¦ã‚‚<code>${prefix}bosh-kubo-worker</code>ã‚¿ã‚°ãŒã¤ã„ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ã€‚ã€‚<a href="https://github.com/cloudfoundry-incubator/kubo-deployment/issues/162">kubo-deployment#162</a>ä¿®æ­£å¾…ã¡ã€‚)</p>
<h3 id="kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³</h3>
<p>Masterã¨Etcdã‚’1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¸›ã‚‰ã—ã¾ã™ã€‚</p>
<pre><code>bosh-cli manifest -d ${prefix}cluster &gt; kubo.yml
cat &lt;&lt;EOF &gt; scale-in.yml
- type: replace
  path: /instance_groups/name=etcd/instances
  value: 1
- type: replace
  path: /instance_groups/name=master/instances
  value: 1
- type: replace
  path: /instance_groups/name=worker/instances
  value: 3
EOF
bosh-cli deploy -d ${prefix}cluster &lt;(bosh-cli int kubo.yml -o scale-in.yml)
</code></pre><p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/32b987e9-d516-f80c-6485-84accbf2d025.png" alt="image.png"></p>
<pre><code>$ bosh-cli vms
Using environment &#39;10.0.1.252&#39; as client &#39;admin&#39;
Task 64. Done
Deployment &#39;fe-tmaki-kubocluster&#39;
Instance                                     Process State  AZ  IPs        VM CID                                   VM Type
etcd/7ea9a870-cc1e-490e-9ead-230a7ebc945a    running        z1  10.0.1.11  vm-f8fa6f1b-51cb-4335-46bc-d0def79d3143  common
master/b003dbd2-b6a4-4d79-93b4-fb00d71cd4a1  running        z1  10.0.1.4   vm-8ff505ae-8f28-40fe-6fd5-01745368e5c3  master
worker/1c356a7e-50e4-4b1e-8edd-ec7ba943cc28  running        z1  10.0.1.8   vm-1823d788-e7b3-488f-66ec-e1c5d085a797  worker
worker/21cc8f19-7bf3-407e-b4a7-d07f67510935  running        z1  10.0.1.6   vm-f6dbd590-20a2-44e6-6be3-a2328639c9e4  worker
worker/e0393799-dfe4-4a6a-be5c-fa21d6c71836  running        z1  10.0.1.5   vm-e9e1b93f-5ec1-4ac5-4b7a-165a4e934a71  worker
</code></pre><h3 id="kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®åœæ­¢</h3>
<p><code>bosh-cli stop</code>ã§ã‚¯ãƒ©ã‚¹ã‚¿ã‚’åœæ­¢ã§ãã¾ã™ãŒã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ—ãƒ­ã‚»ã‚¹ãŒåœæ­¢ã™ã‚‹ã ã‘ã§ã™ã€‚VMã®å‰Šé™¤ã¾ã§è¡Œã„ãŸã„å ´åˆã¯ã€<code>--hard</code>ã‚’ã¤ã‘ã¾ã™ã€‚</p>
<p><a href="https://github.com/cloudfoundry-incubator/etcd-release#failed-deploys-upgrades-split-brain-scenarios-etc">Cloud Foundryã§ã®çµŒé¨“</a>ä¸Šã€stopå‰ã®etcdã¯1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¸›ã‚‰ã—ã¦ãŠãã®ãŒç„¡é›£ã§ã™ã€‚</p>
<pre><code>bosh-cli stop --hard -d ${prefix}cluster
</code></pre><p>Master, Etcd, Workerã®VMãŒå‰Šé™¤ã•ã‚ŒãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/11bc343a-4790-181f-4d56-2811d674b843.png" alt="image.png"></p>
<p>VMã¯å‰Šé™¤ã•ã‚Œã¾ã™ãŒã€Persistent Diskã¯æ®‹ã£ã¦ã„ã¾ã™ã€‚</p>
<blockquote>
<p>æ³¨æ„: é‹ç”¨ä¸­ã¯è¡Œã‚ãªã„æ“ä½œã§ã™ã€‚å‹•ä½œç¢ºèªä¸­ã«èª²é‡‘æ™‚é–“ã‚’å°‘ãªãã—ãŸã„å ´åˆã®ã¿è¡Œã„ã¾ã™ã€‚</p>
</blockquote>
<h3 id="kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®å†é–‹</h3>
<p>åœæ­¢ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ã¯<code>bosh-cli start</code>ã§å†é–‹ã§ãã¾ã™ã€‚</p>
<pre><code>bosh-cli start -d ${prefix}cluster
</code></pre><p>IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å†å‰²ã‚Šå½“ã¦ã•ã‚Œã¾ã™ã€‚</p>
<pre><code>$ bosh-cli vms
Using environment &#39;10.0.1.252&#39; as client &#39;admin&#39;
Task 71. Done
Deployment &#39;fe-tmaki-kubocluster&#39;
Instance                                     Process State  AZ  IPs       VM CID                                   VM Type
etcd/7ea9a870-cc1e-490e-9ead-230a7ebc945a    running        z1  10.0.1.8  vm-2abe4bd8-6c47-4d54-7ac0-d404daf857c2  common
master/b003dbd2-b6a4-4d79-93b4-fb00d71cd4a1  running        z1  10.0.1.4  vm-8aa68b01-ea2a-46d4-628f-de9640753baf  master
worker/1c356a7e-50e4-4b1e-8edd-ec7ba943cc28  running        z1  10.0.1.5  vm-bc2d88c0-7e20-46c3-7ecd-cca800e65c89  worker
worker/21cc8f19-7bf3-407e-b4a7-d07f67510935  running        z1  10.0.1.6  vm-c37a7eaf-8a67-4d9f-7e27-83cf70548dda  worker
worker/e0393799-dfe4-4a6a-be5c-fa21d6c71836  running        z1  10.0.1.7  vm-ec528f91-6222-4b41-5094-99d0a3e21eed  worker
5 vms
Succeeded
</code></pre><p><img src="https://qiita-image-store.s3.amazonaws.com/0/1852/6771eafd-a920-4af0-b7a1-9deba057f768.png" alt="image.png"></p>
<h3 id="kubernetes-">Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®å‰Šé™¤</h3>
<p>å‹•ä½œç¢ºèªãŒçµ‚ã‚ã‚Œã°ã€ã‚¯ãƒ©ã‚¹ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
<p>æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§k8sã‚¯ãƒ©ã‚¹ã‚¿ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚</p>
<pre><code>bosh-cli delete-deployment -d ${prefix}cluster
</code></pre><p>ã“ã®æ“ä½œã§BOSH Directorã€NATã€Bastionã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚ã¾ãŸã€KubernetesãŒä½œæˆã—ãŸLBã‚‚å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚</p>
<hr>
<p>GCPã ã¨GKEãŒã‚ã‚‹ã®ã§ã€ã‚ã¾ã‚Šãƒ¡ãƒªãƒƒãƒˆã‚’æ„Ÿã˜ãªã„ã‹ã‚‚ã—ã‚Œãªã„ã‘ã‚Œã©ã‚‚ã€
Cloud Foundryãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã¯Kuboã‚’ä½¿ã†ã“ã¨ã§ã€Cloud Foundryã®Routerã‚’é€šã˜ã¦k8sã®ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ããŸã‚Šã€
å°†æ¥çš„ã«ã¯<code>cf create-service</code>ã§k8sã‚¯ãƒ©ã‚¹ã‚¿ã‚’ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã§ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã€é­…åŠ›çš„ã§ã™ã€‚
ã¾ãŸOpen Service Broker APIã‚’é€šã˜ã¦ã€CF &lt;---&gt; k8sé–“ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ç›¸äº’é‹ç”¨ã‚‚å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ä»Šåº¦ã¯AWSã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã‹ãªã€‚</p>
</div>
</article>
<footer>
    <a href="https://blog.ik.am">BLOG.IK.AM</a> â€” &copy; 2010-2017 <a href="https://twitter.com/making">Toshiaki
    Maki</a>
</footer>
</body>
</html>