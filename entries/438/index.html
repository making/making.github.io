<html>
<head>
    <title>BLOG.IK.AM</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css" rel="stylesheet"/>
    <style>
        body {
            font-size: small;
            font-family: "Sawarabi Mincho";
            margin: 20px;
        }

        a {
            color: darkslategray;
            text-decoration: none;
        }

        article {
            border: darkgrey solid 1px;
            border-radius: 10px;
            padding: 0 10px 10px;
        }

        footer {
            margin: 10px;
        }

        blockquote {
            color: #464646;
            font-style: italic;
            border: darkgrey dotted 1px;
            border-radius: 5px;
            margin: 5px 0;
            padding: 10px;
        }

        pre {
            background-color: dimgray;
            color: white;
            padding: 5px;
            border-radius: 5px;
        }

        h3:before {
            content: "â˜•ï¸ ";
        }

        h4:before {
            content: "ğŸƒ ";
        }

        h5:before {
            content: "âœˆï¸ï¸ ";
        }

        h6:before {
            content: "â˜ï¸ ";
        }

        pre {
            margin-bottom: 10px;
        }
    </style>
</head>
<h1>âœï¸ BLOG.IK.AM</h1>
<p><a href="https://twitter.com/making">@making</a>'s memo</p>
<body>
<article>
    <h2><a href="">Echo Serverã‚’å®Ÿè£…ã—ã¦å­¦ã¶Reactor Nettyã«ã‚ˆã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†</a></h2>
    <p>
        Updated at <span>2017-10-10T16:26:21Z</span> by <span>Toshiaki Maki</span><br>
        Created at <span>2017-10-10T15:34:25Z</span> by <span>Toshiaki Maki</span>
    </p>
    <div><p>Reactor 3.1.0, Reactor Netty 0.7.0ãŒæ­£å¼ã«<a href="https://spring.io/blog/2017/09/28/reactor-bismuth-is-out">ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ</a>ã®ã§ã€TCP Serverç‰ˆHello Worldã§ã‚ã‚‹Echo Serverã‚’Reactor Nettyã§å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚</p>
<p><strong>ç›®æ¬¡</strong></p>
<!-- toc -->
<ul>
<li><a href="#-">ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ </a></li>
<li><a href="#echo-server-">Echo Serverã‚’å®Ÿè£…</a></li>
<li><a href="#echo-server-">Echo Serverã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°å‡¦ç†</a></li>
</ul>
<!-- tocstop -->
<h3 id="-">ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ </h3>
<p>Reactor 3.1.0ç³»ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¯<code>reactor-bom</code>ã®<code>Bismuth</code>ã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’<code>&lt;dependencyManagement&gt;</code>ã«è¨­å®šã—ã¦ãŠã‘ã°<code>&lt;dependencies&gt;</code>å†…ã§ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ˜ç¤ºã¯ä¸è¦ã§ã™ã€‚</p>
<pre><code class="lang-xml">    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.projectreactor.ipc&lt;/groupId&gt;
            &lt;artifactId&gt;reactor-netty&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
            &lt;artifactId&gt;reactor-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
                &lt;artifactId&gt;reactor-bom&lt;/artifactId&gt;
                &lt;version&gt;Bismuth-RELEASE&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;
</code></pre>
<h3 id="echo-server-">Echo Serverã‚’å®Ÿè£…</h3>
<p>Reactor Nettyã®<code>TcpServer</code>ã®ä½¿ã„æ–¹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚</p>
<pre><code class="lang-java">import org.reactivestreams.Publisher;
import reactor.core.publisher.Flux;
import reactor.ipc.netty.NettyInbound;
import reactor.ipc.netty.NettyOutbound;
import reactor.ipc.netty.tcp.TcpServer;

import java.util.Optional;
import java.util.function.BiFunction;

public class EchoServer {
    public static void main(String[] args) {
        TcpServer tcpServer = TcpServer.create(&quot;0.0.0.0&quot;, 7777);
        tcpServer.startAndAwait(new BiFunction&lt;NettyInbound, NettyOutbound, Publisher&lt;Void&gt;&gt;() {
            @Override
            public Publisher&lt;Void&gt; apply(NettyInbound inbound, NettyOutbound outbound) {
                // ã“ã“ã«å…¥åŠ› =&gt; å‡ºåŠ›ã®å‡¦ç†ã‚’æ›¸ã
                return Flux.never();
            }
        });
    }
}
</code></pre>
<p>ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«æ…£ã‚Œã¦ã„ã‚Œã°ã€&quot;ã‚ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†ãƒãƒ³ãƒ‰ãƒ©ã‚’ãƒ©ãƒ ãƒ€ã§æ›¸ã‘ã°ã„ã„ã‚“ã ãª&quot;ã¨æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ã“ã‚Œã¯ã‚ã‚‹æ„å‘³åˆã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€é€šå¸¸ã®&quot;å‡¦ç†ãƒãƒ³ãƒ‰ãƒ©&quot;ã¨å¤§ããé•ã†ã®ã¯ã€ã“ã®ãƒãƒ³ãƒ‰ãƒ©(<code>BiFunction&lt;NettyInbound, NettyOutbound, Publisher&lt;Void&gt;&gt;</code>)ãŒæ‰±ã†ã®ã¯1ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã¯ãªãã€ç„¡é™ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ã‚ã‚‹ã¨ã„ã†ç‚¹ã§ã™ã€‚
å¼•æ•°ã®<code>NettyInbound</code>/<code>NettyOutbound</code>ã¯Servletã®<code>HttpServletRequest</code>/<code>HttpServletResponse</code>ã®ã‚ˆã†ã«1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã¯ãªãã€ã“ã®ã‚µãƒ¼ãƒãƒ¼ã¸ã®å…¥å‡ºåŠ›å…¨ä½“ã‚’è¡¨ã—ã¾ã™ã€‚ãªã®ã§ã€ã“ã®å‡¦ç†ãƒãƒ³ãƒ‰ãƒ©ã®è¿”ã‚Šå€¤ãŒå‡ºåŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ãªã‚‹ã‚ã‘ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚å‡¦ç†ãŒçµ‚ã‚ã‚‰ãªã„ã‚ˆã†ã«<code>Flux.never()</code>(ãƒ‡ãƒ¼ã‚¿ã¯æµã‚Œãªã„ã‘ã©çµ‚ã‚ã‚‰ãªã„ã‚¹ãƒˆãƒªãƒ¼ãƒ )ã‚’è¿”ã—ã¾ã™ã€‚</p>
<p>å…¥åŠ›ã¨ã—ã¦æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡å­—åˆ—ã«çµã‚Šã¾ã—ã‚‡ã†ã€‚ã“ã®å ´åˆã€å…¥åŠ›ã¨ãªã‚‹æ–‡å­—åˆ—ã®ç„¡é™ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’<code>Flux</code>ã§æ¬¡ã®ã‚ˆã†ã«å–å¾—ã§ãã¾ã™ã€‚</p>
<pre><code class="lang-java">        tcpServer.startAndAwait(new BiFunction&lt;NettyInbound, NettyOutbound, Publisher&lt;Void&gt;&gt;() {
            @Override
            public Publisher&lt;Void&gt; apply(NettyInbound inbound, NettyOutbound outbound) {
                Flux&lt;String&gt; input = inbound.receive().asString();

                return Flux.never();
            }
        });
</code></pre>
<p>ã“ã®å…¥åŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åŠ å·¥ã—ã¦å‡ºåŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«é€ã‚Šã¾ã™ã€‚
ã“ã“ã§é€šå¸¸ã®ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ã‚ˆã†ã«ã€1ä»¶ãšã¤å‡¦ç†ã—ãŸã„ã¨è€ƒãˆã¾ã™ã€‚<code>Flux</code>ã‚¯ãƒ©ã‚¹ã«ã¯ãƒ‡ãƒ¼ã‚¿1ä»¶ã”ã¨ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦<code>doOnNext(Consumer&lt;T&gt;)</code>ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ä½¿ã†ã¨ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ï¼ˆã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ãƒ©ãƒ ãƒ€å¼ã‚’ä½¿ã£ã¦ã„ã¾ã›ã‚“ï¼‰</p>
<pre><code class="lang-java">        tcpServer.startAndAwait(new BiFunction&lt;NettyInbound, NettyOutbound, Publisher&lt;Void&gt;&gt;() {
            @Override
            public Publisher&lt;Void&gt; apply(NettyInbound inbound, NettyOutbound outbound) {
                Flux&lt;String&gt; input = inbound.receive().asString();

                input.doOnNext(new Consumer&lt;String&gt;() {
                    @Override
                    public void accept(String message) {
                      // æ–‡å­—åˆ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€ä»¶ãšã¤ã®å‡¦ç†
                    }
                }).subscribe();

                return Flux.never();
            }
        });
</code></pre>
<p>æ³¨æ„ç‚¹ã¨ã—ã¦ã€å…¥åŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®<code>Flux</code>ã¯<code>subscribe</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã°ãªã„ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ãŒæµã‚Œã¾ã›ã‚“ã€‚</p>
<p>å‡ºåŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚</p>
<pre><code class="lang-java">        tcpServer.startAndAwait(new BiFunction&lt;NettyInbound, NettyOutbound, Publisher&lt;Void&gt;&gt;() {
            @Override
            public Publisher&lt;Void&gt; apply(NettyInbound inbound, NettyOutbound outbound) {
                Flux&lt;String&gt; input = inbound.receive().asString();

                input.doOnNext(new Consumer&lt;String&gt;() {
                    @Override
                    public void accept(String message) {
                        outbound.sendString(Mono.just(message))
                                .then()
                                .subscribe();
                    }
                }).subscribe();

                return Flux.never();
            }
        });
</code></pre>
<p><code>NettyOutbound.sendString</code>ã¯å¼•æ•°ãŒ<code>Publisher&lt;String&gt;</code>ãªã®ã§ã€<code>String</code>ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’<code>Mono.just</code>ã§åŒ…ã‚“ã§ã„ã¾ã™ã€‚ã“ã®è¿”ã‚Šå€¤ãŒå‡ºåŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ãªã‚Šã¾ã™ã€‚ã“ã®å‹ã‚‚<code>NettyOutbound</code>ã§ã™ã€‚ã“ã‚Œã¯<code>Publisher&lt;Void&gt;</code>ã‚’ç¶™æ‰¿ã—ã¦ã„ã¾ã™ã€‚</p>
<p>å…¥åŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ åŒæ§˜ã«å‡ºåŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚‚<code>subscribe</code>ã—ãªã„ã¨ãƒ‡ãƒ¼ã‚¿ãŒæµã‚Œã¾ã›ã‚“ã€‚
ã“ã“ã§ã¯<code>then</code>ãƒ¡ã‚½ãƒƒãƒ‰ã§<code>Mono</code>ã«å¤‰æ›ã—ã¦<code>subscribe</code>ã—ã¾ã™ã€‚</p>
<p>ã“ã“ã¾ã§ã§Echo ServerãŒã§ãã¾ã—ãŸã€‚<code>main</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•æ™‚ã€<code>telnet</code>ã§TCPã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚</p>
<pre><code>$ telnet localhost 7777
Trying ::1...
Connected to localhost.
Escape character is &#39;^]&#39;.
hoge &lt;== å…¥åŠ›
hoge ==&gt; å‡ºåŠ›
foo &lt;== å…¥åŠ›
foo ==&gt; å‡ºåŠ›
bar &lt;== å…¥åŠ›
bar ==&gt; å‡ºåŠ›
^]
telnet&gt; quit
Connection closed.
</code></pre><p><code>nc</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚‚å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚</p>
<pre><code>$ echo -n &#39;Hello World!&#39; | nc localhost 7777
Hello World!
</code></pre><p>ä¸Šè¨˜ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ãƒ©ãƒ ãƒ€å¼ã‚’ä½¿ã†ã¨æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚</p>
<pre><code class="lang-java">    public static void main(String[] args) {
        TcpServer tcpServer = TcpServer.create(&quot;0.0.0.0&quot;, 7777);
        tcpServer.startAndAwait((inbound, outbound) -&gt; {
            Flux&lt;String&gt; input = inbound.receive().asString();
            input.doOnNext(message -&gt; outbound.sendString(Mono.just(message))
                    .then()
                    .subscribe()).subscribe();
            return Flux.never();
        });
    }
</code></pre>
<p>å®Ÿéš›ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«æµã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«<code>log</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>
<pre><code class="lang-java">    public static void main(String[] args) {
        TcpServer tcpServer = TcpServer.create(&quot;0.0.0.0&quot;, 7777);
        tcpServer.startAndAwait((inbound, outbound) -&gt; {
            Flux&lt;String&gt; input = inbound.receive().asString();
            input.doOnNext(message -&gt; outbound.sendString(Mono.just(message).log() /*è¿½åŠ */)
                    .then()
                    .subscribe()).subscribe();
            return Flux.never();
        });
    }
</code></pre>
<p>ã“ã‚Œã§å†èµ·å‹•ã—ã€å†åº¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãªãƒ­ã‚°ã‚’ç¢ºèªã§ãã¾ã™ã€‚<code>onNext</code>ã§å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæµã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<pre><code>[ INFO] (reactor-tcp-nio-2) | onSubscribe([Synchronous Fuseable] Operators.ScalarSubscription)
[ INFO] (reactor-tcp-nio-2) | request(32)
[ INFO] (reactor-tcp-nio-2) | onNext(Hello World!)
[TRACE] (reactor-tcp-nio-2) [id: 0x8984720e, L:/0:0:0:0:0:0:0:1:7777 - R:/0:0:0:0:0:0:0:1:52269] Pending write size = 12
[ INFO] (reactor-tcp-nio-2) | request(1)
[ INFO] (reactor-tcp-nio-2) | onComplete()
</code></pre><p>å‡ºåŠ›å´ã®<code>subscribe</code>ã‚’å‰Šé™¤ã™ã‚‹ã¨<code>onNext</code>ãƒ­ã‚°ãŒã§ãªã„ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã§ã—ã‚‡ã†ã€‚</p>
<p>å°‘ã—ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã—ã¦ã¿ã¾ã™ã€‚</p>
<p>ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯å…¥åŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®<code>doOnNext</code>ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§å‡ºåŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œæˆã—ãŸãŸã‚ã€ä¸¡æ–¹ã®<code>subscribe</code>ãŒå¿…è¦ã§ã—ãŸã€‚
ã“ã“ã§è€ƒãˆæ–¹ã‚’å¤‰ãˆã¦ã€å…¥åŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å¤‰æ›ã—ã¦å‡ºåŠ›ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã€ä½œæˆã•ã‚ŒãŸã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’<code>subscribe</code>ã™ã‚‹ã ã‘ã§å…¥å‡ºåŠ›ä¸¡æ–¹ã«ãƒ‡ãƒ¼ã‚¿ãŒæµã‚Œã¾ã™ã€‚å¤‰æ›ã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨å…ƒã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åˆæµã•ã›ã‚‹ã«ã¯<code>flatMap</code>ã‚’ä½¿ã„ã¾ã™ã€‚<code>flatMap</code>ã‚’ä½¿ãˆã°EchoServerã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
<pre><code class="lang-java">    public static void main(String[] args) {
        TcpServer tcpServer = TcpServer.create(&quot;0.0.0.0&quot;, 7777);
        tcpServer.startAndAwait((inbound, outbound) -&gt; {
            Flux&lt;String&gt; input = inbound.receive().asString();
            input.flatMap(message -&gt; outbound.sendString(Mono.just(message)))
                    .subscribe();
            return Flux.never();
        });
    }
</code></pre>
<p>è¦‹ãŸç›®ãŒã™ã£ãã‚Šã—ã¾ã—ãŸã€‚</p>
<blockquote>
<p>ã¡ãªã¿ã«ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã§<code>flatMap</code>ã‚’<code>map</code>ã«å¤‰ãˆã¦ã‚‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¯é€šã‚Šã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã¯æµã‚Œãªããªã‚Šã¾ã™ã€‚ã“ã®é•ã„ã€ã¨ã¦ã‚‚é‡è¦ãªã®ã§ç†è§£ã—ã¦ãã ã•ã„ã€‚</p>
</blockquote>
<h3 id="echo-server-">Echo Serverã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°å‡¦ç†</h3>
<p>ãŸã ã®Echo Serverã ã¨ã¤ã¾ã‚‰ãªã„ã®ã§ã€ã‚‚ã†å°‘ã—ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†ã£ã½ã„å†…å®¹ã«å¤‰ãˆã¦ã¿ã¾ã™ã€‚</p>
<p><code>NettyOutbound.sendString</code>ã®å¼•æ•°ã¯<code>Publisher&lt;String&gt;</code>ã§ã—ãŸã€‚ã¤ã¾ã‚Šã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’1ä»¶é€ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ãªãã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é€ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚</p>
<p>ã“ã“ã§ã¯ã€EchoServerã‚’3ä»¶ã”ã¨ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã—ã¦ä¸€æ°—ã«å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™ã€‚<code>Flux&lt;String&gt;</code>ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’3ä»¶ãšã¤ã®å¡Šã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ã‚ã‚‹<code>Flux&lt;Flux&lt;String&gt;&gt;</code>ã«å¤‰æ›ã™ã‚‹ã«ã¯<code>window(int)</code>ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
<pre><code class="lang-java">    public static void main(String[] args) {
        TcpServer tcpServer = TcpServer.create(&quot;0.0.0.0&quot;, 7777);
        tcpServer.startAndAwait((inbound, outbound) -&gt; {
            Flux&lt;String&gt; input = inbound.receive().asString();
            input.window(3)
                    .flatMap(messages -&gt; outbound.sendString(messages))
                    .subscribe();
            return Flux.never();
        });
    }
</code></pre>
<p>ã“ã‚Œã§3ä»¶ãšã¤ã¾ã¨ã‚ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†EchoServerã«ãªã‚Šã¾ã—ãŸã€‚
<code>telnet</code>ã§å‹•ä½œç¢ºèªã—ã¦ã¿ã¾ã™ã€‚</p>
<pre><code>$ telnet localhost 7777
Trying ::1...
Connected to localhost.
Escape character is &#39;^]&#39;.
hoge &lt;== å…¥åŠ›
foo &lt;== å…¥åŠ›
bar &lt;== å…¥åŠ›
hoge ==&gt; å‡ºåŠ›
foo ==&gt; å‡ºåŠ›
bar ==&gt; å‡ºåŠ›
^]
telnet&gt; quit
Connection closed.
</code></pre><p>å‰ã®ä¾‹ã¨ç•°ãªã‚Šã€3ä»¶å˜ä½ã§ãƒ‡ãƒ¼ã‚¿ãŒæµã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<hr>
<p>Echo Serverã‚’å®Ÿè£…ã‚’é€šã˜ã¦Reactor Nettyã‚’ä½¿ã£ãŸTCP Serverã®ä½œã‚Šæ–¹åŠã³ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’æ‰±ã†ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®è€ƒãˆæ–¹ã‚’ç°¡å˜ã«å­¦ã³ã¾ã—ãŸã€‚
Reactorã‚’ä½¿ã†ã“ã¨ã§ã“ã‚Œã¾ã§ä½¿ã£ã¦ã“ãªã‹ã£ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ è„³ã§è€ƒãˆãªã„ã¨ã„ã‘ãªã„å ´é¢ãŒå¢—ãˆã¦ãã‚‹ã®ã§ã€ã“ã®è¨˜äº‹ãŒã¨ã£ã‹ã‹ã‚Šã«ãªã‚Œã°ã¨æ€ã„ã¾ã™ã€‚</p>
</div>
</article>
<footer>
    <a href="https://blog.ik.am">BLOG.IK.AM</a> â€” &copy; 2010-2017 <a href="https://twitter.com/making">Toshiaki
    Maki</a>
</footer>
</body>
</html>